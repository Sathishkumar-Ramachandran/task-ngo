{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 51, "column": 0}, "map": {"version":3,"sources":["file:///D:/Task/task-ngo/lib/database/client.js"],"sourcesContent":["const sqlite3 = require('sqlite3').verbose();\r\nconst path = require('path');\r\n\r\n// Use process.cwd() to ensure we target the project root in Next.js\r\nconst dbPath = path.resolve(process.cwd(), 'ngo.db');\r\n\r\nconst db = new sqlite3.Database(dbPath, (err) => {\r\n  if (err) {\r\n    console.error('Could not connect to database', err);\r\n  } else {\r\n    console.log('Connected to SQLite database at', dbPath);\r\n  }\r\n});\r\n\r\n// Promisify the query function to match the pg interface\r\nmodule.exports = {\r\n  query: (text, params = []) => {\r\n    return new Promise((resolve, reject) => {\r\n      // SQLite doesn't support $1, $2 syntax natively in the same way as PG for all drivers, \r\n      // but sqlite3 uses ? placeholders. We need to convert or ensure usage matches.\r\n      \r\n      // Simple regex to replace $1, $2... with ?\r\n      const sql = text.replace(/\\$\\d+/g, '?');\r\n\r\n      if (text.trim().toUpperCase().startsWith('SELECT')) {\r\n        db.all(sql, params, (err, rows) => {\r\n          if (err) reject(err);\r\n          else resolve({ rows });\r\n        });\r\n      } else {\r\n        db.run(sql, params, function (err) {\r\n          if (err) reject(err);\r\n          else resolve({ rows: [], rowCount: this.changes });\r\n        });\r\n      }\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":"AAAA,MAAM,UAAU,yEAAmB,OAAO;AAC1C,MAAM;AAEN,oEAAoE;AACpE,MAAM,SAAS,KAAK,OAAO,CAAC,QAAQ,GAAG,IAAI;AAE3C,MAAM,KAAK,IAAI,QAAQ,QAAQ,CAAC,QAAQ,CAAC;IACvC,IAAI,KAAK;QACP,QAAQ,KAAK,CAAC,iCAAiC;IACjD,OAAO;QACL,QAAQ,GAAG,CAAC,mCAAmC;IACjD;AACF;AAEA,yDAAyD;AACzD,OAAO,OAAO,GAAG;IACf,OAAO,CAAC,MAAM,SAAS,EAAE;QACvB,OAAO,IAAI,QAAQ,CAAC,SAAS;YAC3B,wFAAwF;YACxF,+EAA+E;YAE/E,2CAA2C;YAC3C,MAAM,MAAM,KAAK,OAAO,CAAC,UAAU;YAEnC,IAAI,KAAK,IAAI,GAAG,WAAW,GAAG,UAAU,CAAC,WAAW;gBAClD,GAAG,GAAG,CAAC,KAAK,QAAQ,CAAC,KAAK;oBACxB,IAAI,KAAK,OAAO;yBACX,QAAQ;wBAAE;oBAAK;gBACtB;YACF,OAAO;gBACL,GAAG,GAAG,CAAC,KAAK,QAAQ,SAAU,GAAG;oBAC/B,IAAI,KAAK,OAAO;yBACX,QAAQ;wBAAE,MAAM,EAAE;wBAAE,UAAU,IAAI,CAAC,OAAO;oBAAC;gBAClD;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 92, "column": 0}, "map": {"version":3,"sources":["file:///D:/Task/task-ngo/lib/worker/jobProcessor.js"],"sourcesContent":["const fs = require('fs');\r\nconst csv = require('csv-parser');\r\nconst db = require('../database/client');\r\n\r\nmodule.exports = async (job) => {\r\n  console.log(`Processing job ${job.id} with file:`, job.data.filePath);\r\n  const { filePath } = job.data;\r\n  \r\n  const results = [];\r\n  const errors = [];\r\n  let processedCount = 0;\r\n\r\n  // 1. Parse CSV\r\n  await new Promise((resolve, reject) => {\r\n    fs.createReadStream(filePath)\r\n      .pipe(csv())\r\n      .on('data', (data) => results.push(data))\r\n      .on('end', resolve)\r\n      .on('error', reject);\r\n  });\r\n\r\n  const totalRows = results.length;\r\n  console.log(`Parsed ${totalRows} rows from CSV.`);\r\n\r\n  // 2. Process each row\r\n  for (let i = 0; i < totalRows; i++) {\r\n    const row = results[i];\r\n    try {\r\n      // Validate row data (basic check)\r\n      if (!row.ngo_id || !row.month) {\r\n        throw new Error('Missing ngo_id or month');\r\n      }\r\n\r\n      // Insert into DB\r\n      const query = `\r\n        INSERT INTO reports (ngo_id, month, people_helped, events_conducted, funds_utilized)\r\n        VALUES ($1, $2, $3, $4, $5)\r\n        ON CONFLICT (ngo_id, month) \r\n        DO UPDATE SET \r\n          people_helped = EXCLUDED.people_helped,\r\n          events_conducted = EXCLUDED.events_conducted,\r\n          funds_utilized = EXCLUDED.funds_utilized;\r\n      `;\r\n      \r\n      const values = [\r\n        row.ngo_id, \r\n        row.month, \r\n        parseInt(row.people_helped || 0), \r\n        parseInt(row.events_conducted || 0), \r\n        parseFloat(row.funds_utilized || 0)\r\n      ];\r\n\r\n      await db.query(query, values);\r\n      processedCount++;\r\n\r\n    } catch (err) {\r\n      console.error(`Error processing row ${i + 1}:`, err.message);\r\n      errors.push({ row: i + 1, error: err.message, data: row });\r\n    }\r\n\r\n    // Update progress\r\n    await job.updateProgress(Math.round(((i + 1) / totalRows) * 100));\r\n  }\r\n\r\n  // Cleanup file\r\n  fs.unlink(filePath, (err) => {\r\n    if (err) console.error('Error deleting uploaded file:', err);\r\n  });\r\n\r\n  console.log(`Job ${job.id} completed. Processed: ${processedCount}, Failed: ${errors.length}`);\r\n  \r\n  return { \r\n    processed: processedCount, \r\n    failed: errors.length, \r\n    errors: errors.slice(0, 10) // Return first 10 errors for brevity\r\n  };\r\n};\r\n"],"names":[],"mappings":"AAAA,MAAM;AACN,MAAM;AACN,MAAM;AAEN,OAAO,OAAO,GAAG,OAAO;IACtB,QAAQ,GAAG,CAAC,CAAC,eAAe,EAAE,IAAI,EAAE,CAAC,WAAW,CAAC,EAAE,IAAI,IAAI,CAAC,QAAQ;IACpE,MAAM,EAAE,QAAQ,EAAE,GAAG,IAAI,IAAI;IAE7B,MAAM,UAAU,EAAE;IAClB,MAAM,SAAS,EAAE;IACjB,IAAI,iBAAiB;IAErB,eAAe;IACf,MAAM,IAAI,QAAQ,CAAC,SAAS;QAC1B,GAAG,gBAAgB,CAAC,UACjB,IAAI,CAAC,OACL,EAAE,CAAC,QAAQ,CAAC,OAAS,QAAQ,IAAI,CAAC,OAClC,EAAE,CAAC,OAAO,SACV,EAAE,CAAC,SAAS;IACjB;IAEA,MAAM,YAAY,QAAQ,MAAM;IAChC,QAAQ,GAAG,CAAC,CAAC,OAAO,EAAE,UAAU,eAAe,CAAC;IAEhD,sBAAsB;IACtB,IAAK,IAAI,IAAI,GAAG,IAAI,WAAW,IAAK;QAClC,MAAM,MAAM,OAAO,CAAC,EAAE;QACtB,IAAI;YACF,kCAAkC;YAClC,IAAI,CAAC,IAAI,MAAM,IAAI,CAAC,IAAI,KAAK,EAAE;gBAC7B,MAAM,IAAI,MAAM;YAClB;YAEA,iBAAiB;YACjB,MAAM,QAAQ,CAAC;;;;;;;;MAQf,CAAC;YAED,MAAM,SAAS;gBACb,IAAI,MAAM;gBACV,IAAI,KAAK;gBACT,SAAS,IAAI,aAAa,IAAI;gBAC9B,SAAS,IAAI,gBAAgB,IAAI;gBACjC,WAAW,IAAI,cAAc,IAAI;aAClC;YAED,MAAM,GAAG,KAAK,CAAC,OAAO;YACtB;QAEF,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,CAAC,qBAAqB,EAAE,IAAI,EAAE,CAAC,CAAC,EAAE,IAAI,OAAO;YAC3D,OAAO,IAAI,CAAC;gBAAE,KAAK,IAAI;gBAAG,OAAO,IAAI,OAAO;gBAAE,MAAM;YAAI;QAC1D;QAEA,kBAAkB;QAClB,MAAM,IAAI,cAAc,CAAC,KAAK,KAAK,CAAC,AAAC,CAAC,IAAI,CAAC,IAAI,YAAa;IAC9D;IAEA,eAAe;IACf,GAAG,MAAM,CAAC,UAAU,CAAC;QACnB,IAAI,KAAK,QAAQ,KAAK,CAAC,iCAAiC;IAC1D;IAEA,QAAQ,GAAG,CAAC,CAAC,IAAI,EAAE,IAAI,EAAE,CAAC,uBAAuB,EAAE,eAAe,UAAU,EAAE,OAAO,MAAM,EAAE;IAE7F,OAAO;QACL,WAAW;QACX,QAAQ,OAAO,MAAM;QACrB,QAAQ,OAAO,KAAK,CAAC,GAAG,IAAI,qCAAqC;IACnE;AACF"}},
    {"offset": {"line": 159, "column": 0}, "map": {"version":3,"sources":["file:///D:/Task/task-ngo/lib/utils/queue.js"],"sourcesContent":["// Mock Queue for local development without Redis\r\nconst EventEmitter = require('events');\r\nconst jobProcessor = require('../worker/jobProcessor');\r\n\r\nclass MockQueue extends EventEmitter {\r\n  constructor() {\r\n    super();\r\n    this.jobs = new Map();\r\n    this.currentId = 1;\r\n  }\r\n\r\n  async add(name, data) {\r\n    const id = this.currentId++;\r\n    const job = {\r\n      id,\r\n      data,\r\n      progress: 0,\r\n      state: 'active',\r\n      updateProgress: async (val) => {\r\n        job.progress = val;\r\n      },\r\n      getState: async () => job.state\r\n    };\r\n\r\n    this.jobs.set(id.toString(), job);\r\n\r\n    // Process asynchronously\r\n    setTimeout(async () => {\r\n      try {\r\n        await jobProcessor(job);\r\n        job.state = 'completed';\r\n        job.progress = 100;\r\n      } catch (err) {\r\n        console.error(err);\r\n        job.state = 'failed';\r\n      }\r\n    }, 100);\r\n\r\n    return job;\r\n  }\r\n\r\n  async getJob(id) {\r\n    return this.jobs.get(id.toString());\r\n  }\r\n}\r\n\r\nconst reportsQueue = new MockQueue();\r\n\r\nmodule.exports = { reportsQueue };\r\n"],"names":[],"mappings":"AAAA,iDAAiD;AACjD,MAAM;AACN,MAAM;AAEN,MAAM,kBAAkB;IACtB,aAAc;QACZ,KAAK;QACL,IAAI,CAAC,IAAI,GAAG,IAAI;QAChB,IAAI,CAAC,SAAS,GAAG;IACnB;IAEA,MAAM,IAAI,IAAI,EAAE,IAAI,EAAE;QACpB,MAAM,KAAK,IAAI,CAAC,SAAS;QACzB,MAAM,MAAM;YACV;YACA;YACA,UAAU;YACV,OAAO;YACP,gBAAgB,OAAO;gBACrB,IAAI,QAAQ,GAAG;YACjB;YACA,UAAU,UAAY,IAAI,KAAK;QACjC;QAEA,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,QAAQ,IAAI;QAE7B,yBAAyB;QACzB,WAAW;YACT,IAAI;gBACF,MAAM,aAAa;gBACnB,IAAI,KAAK,GAAG;gBACZ,IAAI,QAAQ,GAAG;YACjB,EAAE,OAAO,KAAK;gBACZ,QAAQ,KAAK,CAAC;gBACd,IAAI,KAAK,GAAG;YACd;QACF,GAAG;QAEH,OAAO;IACT;IAEA,MAAM,OAAO,EAAE,EAAE;QACf,OAAO,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,QAAQ;IAClC;AACF;AAEA,MAAM,eAAe,IAAI;AAEzB,OAAO,OAAO,GAAG;IAAE;AAAa"}},
    {"offset": {"line": 205, "column": 0}, "map": {"version":3,"sources":["file:///D:/Task/task-ngo/lib/database/init.js"],"sourcesContent":["const db = require('./client');\r\n\r\nconst initDb = async () => {\r\n  const createTableQuery = `\r\n    CREATE TABLE IF NOT EXISTS reports (\r\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\r\n      ngo_id TEXT NOT NULL,\r\n      month TEXT NOT NULL,\r\n      people_helped INTEGER DEFAULT 0,\r\n      events_conducted INTEGER DEFAULT 0,\r\n      funds_utilized REAL DEFAULT 0,\r\n      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n      UNIQUE(ngo_id, month)\r\n    );\r\n  `;\r\n\r\n  try {\r\n    await db.query(createTableQuery);\r\n    console.log('Database tables initialized (SQLite)');\r\n  } catch (error) {\r\n    console.error('Error initializing database tables:', error);\r\n  }\r\n};\r\n\r\nmodule.exports = initDb;\r\n"],"names":[],"mappings":"AAAA,MAAM;AAEN,MAAM,SAAS;IACb,MAAM,mBAAmB,CAAC;;;;;;;;;;;EAW1B,CAAC;IAED,IAAI;QACF,MAAM,GAAG,KAAK,CAAC;QACf,QAAQ,GAAG,CAAC;IACd,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,uCAAuC;IACvD;AACF;AAEA,OAAO,OAAO,GAAG"}},
    {"offset": {"line": 231, "column": 0}, "map": {"version":3,"sources":["file:///D:/Task/task-ngo/pages/api/reports/upload.js"],"sourcesContent":["import multer from 'multer';\r\nimport { reportsQueue } from '../../../lib/utils/queue';\r\nimport initDb from '../../../lib/database/init';\r\n\r\n// Initialize DB once\r\nlet initialized = false;\r\n\r\nconst upload = multer({ dest: 'uploads/' });\r\n\r\nexport const config = {\r\n  api: {\r\n    bodyParser: false,\r\n  },\r\n};\r\n\r\nfunction runMiddleware(req, res, fn) {\r\n  return new Promise((resolve, reject) => {\r\n    fn(req, res, (result) => {\r\n      if (result instanceof Error) {\r\n        return reject(result);\r\n      }\r\n      return resolve(result);\r\n    });\r\n  });\r\n}\r\n\r\nexport default async function handler(req, res) {\r\n  if (!initialized) {\r\n    await initDb();\r\n    initialized = true;\r\n  }\r\n\r\n  if (req.method !== 'POST') {\r\n    return res.status(405).json({ error: 'Method not allowed' });\r\n  }\r\n\r\n  try {\r\n    await runMiddleware(req, res, upload.single('file'));\r\n\r\n    if (!req.file) {\r\n      return res.status(400).json({ error: 'No file uploaded' });\r\n    }\r\n\r\n    const job = await reportsQueue.add('process-csv', {\r\n      filePath: req.file.path,\r\n      originalName: req.file.originalname\r\n    });\r\n\r\n    res.json({ message: 'File uploaded and processing started', jobId: job.id });\r\n  } catch (error) {\r\n    console.error(error);\r\n    res.status(500).json({ error: 'Upload failed' });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAEA,qBAAqB;AACrB,IAAI,cAAc;AAElB,MAAM,SAAS,IAAA,gHAAM,EAAC;IAAE,MAAM;AAAW;AAElC,MAAM,SAAS;IACpB,KAAK;QACH,YAAY;IACd;AACF;AAEA,SAAS,cAAc,GAAG,EAAE,GAAG,EAAE,EAAE;IACjC,OAAO,IAAI,QAAQ,CAAC,SAAS;QAC3B,GAAG,KAAK,KAAK,CAAC;YACZ,IAAI,kBAAkB,OAAO;gBAC3B,OAAO,OAAO;YAChB;YACA,OAAO,QAAQ;QACjB;IACF;AACF;AAEe,eAAe,QAAQ,GAAG,EAAE,GAAG;IAC5C,IAAI,CAAC,aAAa;QAChB,MAAM,IAAA,2HAAM;QACZ,cAAc;IAChB;IAEA,IAAI,IAAI,MAAM,KAAK,QAAQ;QACzB,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAqB;IAC5D;IAEA,IAAI;QACF,MAAM,cAAc,KAAK,KAAK,OAAO,MAAM,CAAC;QAE5C,IAAI,CAAC,IAAI,IAAI,EAAE;YACb,OAAO,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;gBAAE,OAAO;YAAmB;QAC1D;QAEA,MAAM,MAAM,MAAM,8HAAY,CAAC,GAAG,CAAC,eAAe;YAChD,UAAU,IAAI,IAAI,CAAC,IAAI;YACvB,cAAc,IAAI,IAAI,CAAC,YAAY;QACrC;QAEA,IAAI,IAAI,CAAC;YAAE,SAAS;YAAwC,OAAO,IAAI,EAAE;QAAC;IAC5E,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC;QACd,IAAI,MAAM,CAAC,KAAK,IAAI,CAAC;YAAE,OAAO;QAAgB;IAChD;AACF"}}]
}